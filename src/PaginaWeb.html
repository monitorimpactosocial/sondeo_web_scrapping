<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Monitor de Opini√≥n ‚Äî PARACEL v2.0</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    :root {
      --bg: #030712;
      --bg-card: rgba(17, 24, 39, 0.85);
      --bg-glass: rgba(255, 255, 255, 0.04);
      --bg-hover: rgba(255, 255, 255, 0.08);
      --blue: #3b82f6;
      --emerald: #10b981;
      --red: #ef4444;
      --amber: #f59e0b;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --text-muted: #6b7280;
      --border: rgba(75, 85, 99, 0.3);
      --radius: 12px;
      --font: 'Segoe UI', 'Inter', system-ui, sans-serif;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden
    }

    /* Background blobs */
    .bg-effects {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden
    }

    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px)
    }

    .blob-1 {
      top: -10%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: rgba(59, 130, 246, 0.08);
      animation: blobPulse 4s ease-in-out infinite
    }

    .blob-2 {
      bottom: -10%;
      left: -10%;
      width: 400px;
      height: 400px;
      background: rgba(16, 185, 129, 0.06);
      animation: blobPulse 5s ease-in-out infinite 1s
    }

    .blob-3 {
      top: 40%;
      left: 40%;
      width: 500px;
      height: 500px;
      background: rgba(139, 92, 246, 0.04)
    }

    @keyframes blobPulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1)
      }

      50% {
        opacity: 0.6;
        transform: scale(1.1)
      }
    }

    /* Header */
    .header {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 28px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3)
    }

    .header-logo {
      width: 50px;
      height: 50px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--blue), var(--emerald));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 800;
      color: #fff;
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.3);
      position: relative
    }

    .header-logo::after {
      content: '';
      position: absolute;
      bottom: -3px;
      right: -3px;
      width: 14px;
      height: 14px;
      background: var(--emerald);
      border-radius: 50%;
      border: 2px solid var(--bg);
      animation: blobPulse 2s infinite
    }

    .header-title {
      flex: 1
    }

    .header-title h1 {
      font-size: 20px;
      font-weight: 800;
      color: #fff
    }

    .header-title p {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 2px;
      padding: 10px 28px 0;
      background: rgba(17, 24, 39, 0.5);
      border-bottom: 1px solid var(--border)
    }

    .tab {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      transition: all .3s;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .tab:hover {
      color: var(--text)
    }

    .tab.active {
      color: var(--blue);
      border-bottom-color: var(--blue)
    }

    .tab .badge-count {
      background: var(--red);
      color: #fff;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 10px;
      font-weight: 700
    }

    .tab-content {
      display: none;
      padding: 24px 28px;
      position: relative;
      z-index: 1
    }

    .tab-content.active {
      display: block;
      animation: fadeUp .4s ease
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 20px
    }

    .kpi {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all .3s;
      cursor: default
    }

    .kpi:hover {
      border-color: var(--blue);
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.15)
    }

    .kpi-gradient {
      position: absolute;
      inset: 0;
      opacity: 0.05
    }

    .kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted)
    }

    .kpi-icon {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      line-height: 1
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px
    }

    .kpi-sub .trend-up {
      color: var(--emerald)
    }

    .kpi-sub .trend-down {
      color: var(--red)
    }

    .kpi-sparkline {
      height: 30px;
      margin-top: 8px
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 14px;
      backdrop-filter: blur(8px)
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    /* Filters */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
      align-items: flex-end
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .filter-group label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted)
    }

    .filter-group select,
    .filter-group input {
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 8px 12px;
      font-size: 12px;
      font-family: var(--font);
      outline: none;
      min-width: 130px;
      transition: border-color .3s
    }

    .filter-group select:focus,
    .filter-group input:focus {
      border-color: var(--blue)
    }

    .filter-group select option {
      background: #1e293b;
      color: var(--text)
    }

    /* Toggle */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer
    }

    .toggle {
      position: relative;
      width: 36px;
      height: 20px
    }

    .toggle input {
      display: none
    }

    .toggle .slider {
      position: absolute;
      inset: 0;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 20px;
      transition: all .3s
    }

    .toggle .slider::before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      left: 3px;
      top: 2px;
      background: var(--text-muted);
      border-radius: 50%;
      transition: all .3s
    }

    .toggle input:checked+.slider {
      background: var(--blue);
      border-color: var(--blue)
    }

    .toggle input:checked+.slider::before {
      transform: translateX(16px);
      background: #fff
    }

    /* Buttons */
    .btn {
      padding: 9px 18px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all .3s;
      font-family: var(--font);
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--blue), #2563eb);
      color: #fff;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3)
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4)
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 11px
    }

    .btn-outline {
      background: transparent;
      color: var(--blue);
      border: 1px solid var(--blue)
    }

    .btn-outline:hover {
      background: rgba(59, 130, 246, 0.1)
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-dim);
      border: 1px solid var(--border)
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text)
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.15);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.3)
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.25)
    }

    /* Mention Cards */
    .mention-list {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .mention-card {
      background: rgba(17, 24, 39, 0.7);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all .3s;
      animation: fadeUp .4s ease
    }

    .mention-card:hover {
      border-color: rgba(59, 130, 246, 0.3);
      background: rgba(30, 41, 59, 0.7);
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.05)
    }

    .mention-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap
    }

    .mention-title {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      line-height: 1.4
    }

    .mention-title a {
      color: #fff;
      text-decoration: none;
      transition: color .2s
    }

    .mention-title a:hover {
      color: var(--blue);
      text-decoration: underline
    }

    .mention-snippet {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
      margin: 8px 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .mention-footer {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px
    }

    .mention-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 4px
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      border: 1px solid transparent
    }

    .badge-pos {
      background: rgba(16, 185, 129, 0.15);
      color: var(--emerald);
      border-color: rgba(16, 185, 129, 0.3)
    }

    .badge-neg {
      background: rgba(239, 68, 68, 0.15);
      color: var(--red);
      border-color: rgba(239, 68, 68, 0.3)
    }

    .badge-neu {
      background: rgba(107, 114, 128, 0.15);
      color: var(--text-dim);
      border-color: rgba(107, 114, 128, 0.3)
    }

    .badge-source {
      background: var(--bg-glass);
      color: var(--text-dim);
      border-color: var(--border)
    }

    .badge-py {
      background: rgba(59, 130, 246, 0.1);
      color: var(--blue);
      border-color: rgba(59, 130, 246, 0.3)
    }

    .badge-gate-ok {
      color: var(--emerald)
    }

    .badge-gate-no {
      color: var(--red)
    }

    .badge-topic {
      background: rgba(139, 92, 246, 0.1);
      color: var(--purple);
      border-color: rgba(139, 92, 246, 0.2)
    }

    /* Alert Cards */
    .alert-card {
      padding: 14px;
      border-radius: 10px;
      border: 1px solid;
      transition: all .3s;
      margin-bottom: 8px
    }

    .alert-critical {
      background: rgba(239, 68, 68, 0.08);
      border-color: rgba(239, 68, 68, 0.3)
    }

    .alert-high {
      background: rgba(249, 115, 22, 0.08);
      border-color: rgba(249, 115, 22, 0.3)
    }

    .alert-medium {
      background: rgba(234, 179, 8, 0.08);
      border-color: rgba(234, 179, 8, 0.3)
    }

    .alert-low {
      background: rgba(59, 130, 246, 0.08);
      border-color: rgba(59, 130, 246, 0.3)
    }

    .alert-card .alert-msg {
      font-size: 13px;
      color: #fff;
      font-weight: 500
    }

    .alert-card .alert-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 14px;
      margin-bottom: 20px
    }

    .chart-container {
      position: relative;
      height: 280px
    }

    .chart-wide {
      grid-column: span 2
    }

    /* Keyword chips */
    .kw-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0
    }

    .kw-chip {
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all .3s
    }

    .kw-chip.on {
      border-color: rgba(16, 185, 129, 0.4);
      color: var(--emerald)
    }

    .kw-chip.off {
      border-color: var(--border);
      color: var(--text-muted);
      opacity: 0.5
    }

    .kw-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: all .2s
    }

    .kw-dot.on {
      background: var(--emerald)
    }

    .kw-dot.off {
      background: var(--text-muted)
    }

    .kw-del {
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      margin-left: 4px;
      transition: color .2s
    }

    .kw-del:hover {
      color: var(--red)
    }

    .kw-count {
      font-size: 10px;
      color: var(--text-muted)
    }

    /* Status panel */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin: 14px 0
    }

    .status-item {
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      text-align: center
    }

    .status-item .s-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted)
    }

    .status-item .s-value {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-top: 4px
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 14px
    }

    .pagination button {
      background: var(--bg-glass);
      border: 1px solid var(--border);
      color: var(--text-dim);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer
    }

    .pagination button:hover {
      border-color: var(--blue)
    }

    .pagination button.active {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue)
    }

    .pagination span {
      font-size: 12px;
      color: var(--text-muted)
    }

    /* Loading */
    .loading {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(3, 7, 18, 0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      backdrop-filter: blur(4px)
    }

    .loading.show {
      display: flex
    }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 1s linear infinite
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-dim)
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--blue);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 13px;
      color: var(--text);
      z-index: 1001;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      transform: translateY(100px);
      opacity: 0;
      transition: all .4s
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1
    }

    /* Progress */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-glass);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--blue), var(--emerald));
      border-radius: 3px;
      transition: width .5s ease
    }

    /* Responsive */
    @media(max-width:768px) {
      .header {
        padding: 12px 16px
      }

      .tabs {
        padding: 8px 16px 0;
        overflow-x: auto
      }

      .tab-content {
        padding: 16px
      }

      .filters {
        flex-direction: column
      }

      .charts-grid {
        grid-template-columns: 1fr
      }

      .chart-wide {
        grid-column: span 1
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr)
      }
    }
  </style>
</head>

<body>
  <div class="bg-effects">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="header-logo">P</div>
    <div class="header-title">
      <h1>Monitor de Opini√≥n ‚Äî PARACEL</h1>
      <p>Sondeo Web Scrapping ¬∑ Monitoreo de Impacto Social ¬∑ v2.0</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì• CSV</button>
      <button class="btn btn-ghost btn-sm" onclick="refreshAll()">üîÑ</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button class="tab" onclick="switchTab('busqueda')">üîç B√∫squeda</button>
    <button class="tab" onclick="switchTab('menciones')">üì∞ Menciones</button>
    <button class="tab" onclick="switchTab('alertas')">üîî Alertas <span class="badge-count" id="alertBadge"
        style="display:none">0</span></button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-dashboard" class="tab-content active">
    <div class="kpi-grid" id="kpiGrid">
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--blue),var(--cyan))"></div>
        <div class="kpi-header"><span class="kpi-label">Total Menciones</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--blue),var(--cyan))">üìä</div>
        </div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub" id="kpiTotalSub"></div>
      </div>
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--emerald),#059669)"></div>
        <div class="kpi-header"><span class="kpi-label">Menciones Hoy</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--emerald),#059669)">üìà</div>
        </div>
        <div class="kpi-value" id="kpiHoy">0</div>
        <div class="kpi-sub" id="kpiHoySub"></div>
      </div>
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--amber),#d97706)"></div>
        <div class="kpi-header"><span class="kpi-label">Sentimiento Prom.</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--amber),#d97706)">üòä</div>
        </div>
        <div class="kpi-value" id="kpiSent">0</div>
        <div class="kpi-sub" id="kpiSentSub"></div>
      </div>
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--purple),#7c3aed)"></div>
        <div class="kpi-header"><span class="kpi-label">Confianza Prom.</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--purple),#7c3aed)">üéØ</div>
        </div>
        <div class="kpi-value" id="kpiConf">0%</div>
        <div class="kpi-sub" id="kpiConfSub"></div>
      </div>
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--cyan),#0891b2)"></div>
        <div class="kpi-header"><span class="kpi-label">Gate Pass Rate</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--cyan),#0891b2)">üõ°Ô∏è</div>
        </div>
        <div class="kpi-value" id="kpiGate">0%</div>
        <div class="kpi-sub" id="kpiGateSub"></div>
      </div>
      <div class="kpi">
        <div class="kpi-gradient" style="background:linear-gradient(135deg,var(--red),#dc2626)"></div>
        <div class="kpi-header"><span class="kpi-label">Top Medio PY</span>
          <div class="kpi-icon" style="background:linear-gradient(135deg,var(--red),#dc2626)">üáµüáæ</div>
        </div>
        <div class="kpi-value" id="kpiTopPY" style="font-size:18px">‚Äî</div>
        <div class="kpi-sub" id="kpiTopPYSub"></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card chart-wide">
        <div class="card-title">üìà Tendencia Semanal (√∫ltimos 7 d√≠as)</div>
        <div class="chart-container"><canvas id="chartTrend"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üòä Sentimiento</div>
        <div class="chart-container"><canvas id="chartSent"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üì° Fuentes</div>
        <div class="chart-container"><canvas id="chartSrc"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üáµüáæ Medios Paraguay</div>
        <div class="chart-container"><canvas id="chartMedia"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üè∑Ô∏è Temas</div>
        <div class="chart-container"><canvas id="chartTopics"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üéØ An√°lisis Multidimensional</div>
        <div class="chart-container"><canvas id="chartRadar"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üåç Origen de Medios</div>
        <div class="chart-container"><canvas id="chartOrigin"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: B√öSQUEDA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-busqueda" class="tab-content">
    <div class="card">
      <div class="card-title">‚ö° Ejecuci√≥n</div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-primary" id="btnSearch" onclick="ejecutarBusqueda()">üöÄ Ejecutar B√∫squeda</button>
        <span id="searchProgress" style="font-size:13px;color:var(--text-dim)"></span>
      </div>
      <div id="searchProgressBar" style="display:none">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üì° √öltimo Estado</div>
      <div class="status-grid" id="statusPanel">
        <div class="status-item">
          <div class="s-label">√öltima ejecuci√≥n</div>
          <div class="s-value" id="stLast">‚Äî</div>
        </div>
        <div class="status-item">
          <div class="s-label">Estado</div>
          <div class="s-value" id="stStatus">‚Äî</div>
        </div>
        <div class="status-item">
          <div class="s-label">Duraci√≥n</div>
          <div class="s-value" id="stDur">‚Äî</div>
        </div>
        <div class="status-item">
          <div class="s-label">Nuevas</div>
          <div class="s-value" id="stNew">‚Äî</div>
        </div>
        <div class="status-item">
          <div class="s-label">Duplicadas</div>
          <div class="s-value" id="stDup">‚Äî</div>
        </div>
        <div class="status-item">
          <div class="s-label">Gate OK</div>
          <div class="s-value" id="stGate">‚Äî</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üîë Palabras Clave</div>
      <div id="kwList" class="kw-list"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input type="text" id="newKwInput" placeholder="Nueva keyword‚Ä¶" class="filter-group"
          style="flex:1;min-width:200px">
        <button class="btn btn-sm btn-outline" onclick="agregarKeyword()">+ Agregar</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: MENCIONES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-menciones" class="tab-content">
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">üéõÔ∏è Filtros</div>
      <div class="filters">
        <div class="filter-group"><label>Fuente</label><select id="fFuente">
            <option value="">Todas</option>
          </select></div>
        <div class="filter-group"><label>Medio PY</label><select id="fMedio">
            <option value="">Todos</option>
          </select></div>
        <div class="filter-group"><label>Sentimiento</label><select id="fSent">
            <option value="">Todos</option>
          </select></div>
        <div class="filter-group"><label>Tema</label><select id="fTema">
            <option value="">Todos</option>
          </select></div>
        <div class="filter-group"><label>Desde</label><input type="date" id="fDesde"></div>
        <div class="filter-group"><label>Hasta</label><input type="date" id="fHasta"></div>
        <div class="filter-group"><label>Buscar</label><input type="text" id="fSearch" placeholder="Texto‚Ä¶"></div>
        <div class="filter-group" style="gap:8px">
          <div class="toggle-row"><label class="toggle"><input type="checkbox" id="fGate"><span
                class="slider"></span></label>Solo Gate OK</div>
          <div class="toggle-row"><label class="toggle"><input type="checkbox" id="fPY"><span
                class="slider"></span></label>Solo Medios PY</div>
        </div>
        <div class="filter-group" style="gap:4px">
          <button class="btn btn-primary btn-sm" onclick="applyFilters()">Aplicar</button>
          <button class="btn btn-ghost btn-sm" onclick="resetFilters()">Limpiar</button>
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="font-size:13px;color:var(--text-dim)" id="mentionCount"></span>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì• Exportar CSV</button>
    </div>
    <div class="mention-list" id="mentionList"></div>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: ALERTAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-alertas" class="tab-content">
    <div class="card">
      <div class="card-title">üîî Alertas de Sentimiento Negativo</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px">Menciones con score de sentimiento por debajo
        del umbral configurado que pasaron el gate de contexto Paraguay.</p>
      <div id="alertList"></div>
      <div id="noAlerts" style="text-align:center;padding:40px;color:var(--text-muted);display:none">
        <div style="font-size:40px;margin-bottom:12px">‚úÖ</div>
        <div>No hay alertas pendientes</div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Procesando‚Ä¶</div>
  </div>
  <div class="toast" id="toast"></div>

  <script>
    var S = { tab: 'dashboard', rows: [], stats: {}, page: 1, pageSize: 30, charts: {} };

    function switchTab(t) {
      S.tab = t; S.page = 1;
      document.querySelectorAll('.tab').forEach(function (el, i) {
        el.classList.toggle('active', ['dashboard', 'busqueda', 'menciones', 'alertas'][i] === t);
      });
      document.querySelectorAll('.tab-content').forEach(function (c) { c.classList.remove('active'); });
      document.getElementById('tab-' + t).classList.add('active');
      if (t === 'dashboard') loadDashboard();
      else if (t === 'busqueda') loadSearchStatus();
      else if (t === 'menciones') loadMentions();
      else if (t === 'alertas') loadAlerts();
    }

    function showLoading(m) { document.getElementById('loadingText').textContent = m || 'Procesando‚Ä¶'; document.getElementById('loadingOverlay').classList.add('show'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
    function showToast(m, d) { var t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(function () { t.classList.remove('show') }, d || 3000); }
    function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function refreshAll() { if (S.tab === 'dashboard') loadDashboard(); else if (S.tab === 'busqueda') loadSearchStatus(); else if (S.tab === 'menciones') loadMentions(); else loadAlerts(); }

    function animateValue(el, end, dur, suffix) {
      var start = 0, startTime = null; suffix = suffix || '';
      function step(ts) {
        if (!startTime) startTime = ts;
        var p = Math.min((ts - startTime) / (dur || 800), 1);
        var ease = 1 - Math.pow(1 - p, 3);
        var val = Math.round(end * ease);
        el.textContent = val + suffix;
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    /* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */
    function loadDashboard() {
      showLoading('Cargando dashboard‚Ä¶');
      google.script.run.withSuccessHandler(function (s) {
        S.stats = s || {};
        updateKPIs(s);
        updateCharts(s);
        hideLoading();
      }).withFailureHandler(function (e) { hideLoading(); showToast('Error: ' + e.message, 5000); }).getDashboardStats({});
    }

    function updateKPIs(s) {
      animateValue(document.getElementById('kpiTotal'), s.total || 0, 800);
      document.getElementById('kpiTotalSub').innerHTML = (s.positivas || 0) + ' pos ¬∑ ' + (s.neutrales || 0) + ' neu ¬∑ ' + (s.negativas || 0) + ' neg';
      animateValue(document.getElementById('kpiHoy'), s.hoy || 0, 600);
      document.getElementById('kpiHoySub').innerHTML = 'Ayer: ' + (s.ayer || 0) + (s.hoy > (s.ayer || 0) ? ' <span class="trend-up">‚Üë</span>' : s.hoy < (s.ayer || 0) ? ' <span class="trend-down">‚Üì</span>' : '');
      var avgS = s.avgSentiment || 0;
      document.getElementById('kpiSent').textContent = (avgS >= 0 ? '+' : '') + avgS.toFixed(2);
      document.getElementById('kpiSentSub').textContent = avgS > 0 ? 'Tendencia positiva' : avgS < 0 ? 'Tendencia negativa' : 'Neutral';
      var conf = Math.round((s.avgConfidence || 0) * 100);
      animateValue(document.getElementById('kpiConf'), conf, 600, '%');
      document.getElementById('kpiConfSub').textContent = 'Relevancia: ' + Math.round((s.avgRelevance || 0) * 100) + '%';
      var gateTotal = (s.gate?.passed || 0) + (s.gate?.rejected || 0);
      var gateRate = gateTotal > 0 ? Math.round(s.gate.passed / gateTotal * 100) : 0;
      animateValue(document.getElementById('kpiGate'), gateRate, 600, '%');
      document.getElementById('kpiGateSub').textContent = (s.gate?.passed || 0) + ' ok / ' + (s.gate?.rejected || 0) + ' rechazadas';
      document.getElementById('kpiTopPY').textContent = s.topMedioPY || '‚Äî';
      var pyTotal = s.mediaOrigin?.paraguay || 0;
      document.getElementById('kpiTopPYSub').textContent = pyTotal + ' menciones de medios PY';
    }

    function destroyChart(k) { if (S.charts[k]) { S.charts[k].destroy(); S.charts[k] = null; } }
    function chartOpts() {
      return {
        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(75,85,99,0.15)' } }, y: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(75,85,99,0.15)' }, beginAtZero: true } }
      };
    }
    var ttStyle = { backgroundColor: 'rgba(17,24,39,0.95)', borderColor: 'rgba(75,85,99,0.5)', borderRadius: 12, titleColor: '#9ca3af', bodyColor: '#e5e7eb' };

    function updateCharts(s) {
      // Trend
      destroyChart('trend');
      var l7 = s.last7Days || [];
      var labels7 = l7.map(function (d) { return d.date.substring(5) });
      S.charts.trend = new Chart(document.getElementById('chartTrend'), {
        type: 'bar',
        data: {
          labels: labels7, datasets: [
            { label: 'Positivos', data: l7.map(function (d) { return d.sentiment.pos }), backgroundColor: 'rgba(16,185,129,0.7)', borderRadius: 4, stack: 's' },
            { label: 'Neutrales', data: l7.map(function (d) { return d.sentiment.neu }), backgroundColor: 'rgba(107,114,128,0.5)', borderRadius: 4, stack: 's' },
            { label: 'Negativos', data: l7.map(function (d) { return d.sentiment.neg }), backgroundColor: 'rgba(239,68,68,0.7)', borderRadius: 4, stack: 's' }
          ]
        },
        options: Object.assign({}, chartOpts(), { plugins: { legend: { display: true, labels: { color: '#9ca3af', font: { size: 10 } } }, tooltip: ttStyle }, scales: { x: { stacked: true, ticks: { color: '#6b7280', font: { size: 10 } }, grid: { display: false } }, y: { stacked: true, ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(75,85,99,0.15)' }, beginAtZero: true } } })
      });

      // Sentiment donut
      destroyChart('sent');
      S.charts.sent = new Chart(document.getElementById('chartSent'), {
        type: 'doughnut',
        data: { labels: ['Positivo', 'Neutral', 'Negativo'], datasets: [{ data: [s.positivas || 0, s.neutrales || 0, s.negativas || 0], backgroundColor: ['#10b981', '#6b7280', '#ef4444'], borderWidth: 0, borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 11 }, padding: 16 } }, tooltip: ttStyle } }
      });

      // Sources
      destroyChart('src');
      var srcK = Object.keys(s.porFuente || {}).sort(function (a, b) { return (s.porFuente[b] || 0) - (s.porFuente[a] || 0) });
      var srcColors = { GoogleNews: '#4285f4', BingNews: '#00a4ef', Reddit: '#ff4500', Manual: '#8b5cf6' };
      S.charts.src = new Chart(document.getElementById('chartSrc'), {
        type: 'bar',
        data: { labels: srcK, datasets: [{ data: srcK.map(function (k) { return s.porFuente[k] }), backgroundColor: srcK.map(function (k) { return srcColors[k] || '#3b82f6' }), borderRadius: 6 }] },
        options: Object.assign({}, chartOpts(), { indexAxis: 'y' })
      });

      // Media PY
      destroyChart('media');
      var mk = Object.keys(s.porMedioPY || {}).sort(function (a, b) { return (s.porMedioPY[b] || 0) - (s.porMedioPY[a] || 0) }).slice(0, 8);
      S.charts.media = new Chart(document.getElementById('chartMedia'), {
        type: 'bar',
        data: { labels: mk, datasets: [{ data: mk.map(function (k) { return s.porMedioPY[k] }), backgroundColor: 'rgba(59,130,246,0.6)', borderRadius: 6 }] },
        options: Object.assign({}, chartOpts(), { indexAxis: 'y' })
      });

      // Topics
      destroyChart('topics');
      var tk = Object.keys(s.porTema || {});
      var tColors = { Ambiental: '#10b981', Laboral: '#3b82f6', Comunidad: '#8b5cf6', 'Inversi√≥n': '#f59e0b', 'Operaci√≥n': '#ef4444' };
      S.charts.topics = new Chart(document.getElementById('chartTopics'), {
        type: 'bar',
        data: { labels: tk, datasets: [{ data: tk.map(function (k) { return s.porTema[k] }), backgroundColor: tk.map(function (k) { return tColors[k] || '#6b7280' }), borderRadius: 6 }] },
        options: chartOpts()
      });

      // Radar
      destroyChart('radar');
      var gateT = (s.gate?.passed || 0) + (s.gate?.rejected || 0);
      var mediaT = (s.mediaOrigin?.paraguay || 0) + (s.mediaOrigin?.international || 0);
      S.charts.radar = new Chart(document.getElementById('chartRadar'), {
        type: 'radar',
        data: {
          labels: ['Cobertura', 'Relevancia', 'Confianza', 'Sentimiento', 'Gate Pass', 'Medios PY'],
          datasets: [{
            data: [Math.min(100, s.total || 0), Math.round((s.avgRelevance || 0) * 100), Math.round((s.avgConfidence || 0) * 100), Math.round(((s.avgSentiment || 0) + 1) * 50), gateT > 0 ? Math.round(s.gate.passed / gateT * 100) : 0, mediaT > 0 ? Math.round(s.mediaOrigin.paraguay / mediaT * 100) : 0],
            backgroundColor: 'rgba(59,130,246,0.2)', borderColor: '#3b82f6', borderWidth: 2, pointBackgroundColor: '#3b82f6', pointRadius: 4
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { color: 'rgba(75,85,99,0.2)' }, grid: { color: 'rgba(75,85,99,0.2)' }, pointLabels: { color: '#9ca3af', font: { size: 11 } }, ticks: { display: false }, suggestedMin: 0, suggestedMax: 100 } }, plugins: { legend: { display: false } } }
      });

      // Origin donut
      destroyChart('origin');
      S.charts.origin = new Chart(document.getElementById('chartOrigin'), {
        type: 'doughnut',
        data: { labels: ['Paraguay üáµüáæ', 'Internacional üåç'], datasets: [{ data: [s.mediaOrigin?.paraguay || 0, s.mediaOrigin?.international || 0], backgroundColor: ['#3b82f6', '#6b7280'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 11 } } } } }
      });
    }

    /* ‚ïê‚ïê‚ïê B√öSQUEDA ‚ïê‚ïê‚ïê */
    function loadSearchStatus() {
      google.script.run.withSuccessHandler(function (ex) {
        if (!ex) return;
        document.getElementById('stLast').textContent = ex.timestamp || '‚Äî';
        document.getElementById('stStatus').textContent = ex.estado || '‚Äî';
        document.getElementById('stDur').textContent = ex.duracion ? ex.duracion + 's' : '‚Äî';
        document.getElementById('stNew').textContent = ex.nuevas != null ? ex.nuevas : '‚Äî';
        document.getElementById('stDup').textContent = ex.duplicadas != null ? ex.duplicadas : '‚Äî';
        document.getElementById('stGate').textContent = ex.gateOK != null ? ex.gateOK : '‚Äî';
      }).getLastExecution();
      loadKeywords();
    }
    function loadKeywords() {
      google.script.run.withSuccessHandler(function (kws) {
        var c = document.getElementById('kwList'); c.innerHTML = '';
        (kws || []).forEach(function (kw) {
          var cls = String(kw.activa).toUpperCase() === 'SI' ? 'on' : 'off';
          var chip = document.createElement('div');
          chip.className = 'kw-chip ' + cls;
          chip.innerHTML = '<span class="kw-dot ' + cls + '" onclick="toggleKw(\'' + escHtml(kw.keyword).replace(/'/g, "\\'") + '\',' + (cls === 'on' ? 'false' : 'true') + ')"></span>' +
            escHtml(kw.keyword) + ' <span class="kw-count">(' + kw.useCount + ')</span>' +
            '<span class="kw-del" onclick="deleteKw(\'' + escHtml(kw.keyword).replace(/'/g, "\\'") + '\')">√ó</span>';
          c.appendChild(chip);
        });
      }).getKeywords();
    }
    function toggleKw(kw, act) { google.script.run.withSuccessHandler(function () { loadKeywords(); showToast('Keyword actualizada') }).toggleKeyword(kw, act); }
    function deleteKw(kw) { if (!confirm('¬øEliminar "' + kw + '"?')) return; google.script.run.withSuccessHandler(function () { loadKeywords(); showToast('Keyword eliminada') }).deleteKeyword(kw); }
    function agregarKeyword() { var v = document.getElementById('newKwInput').value.trim(); if (!v) return; google.script.run.withSuccessHandler(function () { document.getElementById('newKwInput').value = ''; loadKeywords(); showToast('Keyword agregada') }).addKeyword(v); }

    function ejecutarBusqueda() {
      var btn = document.getElementById('btnSearch'); btn.disabled = true;
      var prog = document.getElementById('searchProgress'); prog.textContent = 'Iniciando b√∫squeda‚Ä¶';
      var bar = document.getElementById('searchProgressBar'); bar.style.display = 'block';
      var fill = document.getElementById('progressFill'); fill.style.width = '10%';
      var pTimer = setInterval(function () { var w = parseInt(fill.style.width) || 10; if (w < 90) fill.style.width = (w + 5) + '%'; }, 2000);
      google.script.run.withSuccessHandler(function (res) {
        clearInterval(pTimer); fill.style.width = '100%'; btn.disabled = false;
        if (res && res.status === 'ok') prog.textContent = '‚úì ' + res.nuevas + ' nuevas (' + res.duplicadas + ' dup, ' + res.alerts + ' alertas)';
        else prog.textContent = '‚ö†Ô∏è ' + (res ? res.message : 'Sin resultados');
        setTimeout(function () { bar.style.display = 'none'; fill.style.width = '0%'; prog.textContent = '' }, 4000);
        loadSearchStatus();
      }).withFailureHandler(function (e) { clearInterval(pTimer); btn.disabled = false; prog.textContent = '‚ùå Error: ' + e.message; bar.style.display = 'none'; }).runManualSearch();
    }

    /* ‚ïê‚ïê‚ïê MENCIONES ‚ïê‚ïê‚ïê */
    function getFilters() {
      return {
        fuente: document.getElementById('fFuente').value, medioPY: document.getElementById('fMedio').value,
        sentimiento: document.getElementById('fSent').value, tema: document.getElementById('fTema').value,
        fechaDesde: document.getElementById('fDesde').value, fechaHasta: document.getElementById('fHasta').value,
        busqueda: document.getElementById('fSearch').value, gateOnly: document.getElementById('fGate').checked,
        soloMediosPY: document.getElementById('fPY').checked
      };
    }
    function applyFilters() { S.page = 1; loadMentions(); }
    function resetFilters() { ['fFuente', 'fMedio', 'fSent', 'fTema'].forEach(function (id) { document.getElementById(id).value = '' }); document.getElementById('fDesde').value = ''; document.getElementById('fHasta').value = ''; document.getElementById('fSearch').value = ''; document.getElementById('fGate').checked = false; document.getElementById('fPY').checked = false; applyFilters(); }

    function loadMentions() {
      showLoading('Cargando menciones‚Ä¶');
      google.script.run.withSuccessHandler(function (data) {
        hideLoading(); S.rows = data.rows || [];
        document.getElementById('mentionCount').textContent = S.rows.length + ' menciones encontradas';
        renderMentions();
      }).withFailureHandler(function (e) { hideLoading(); showToast('Error: ' + e.message, 5000) }).getFilteredData(getFilters());
      google.script.run.withSuccessHandler(populateFilters).getFilterOptions();
    }

    function populateFilters(opts) {
      if (!opts) return;
      fillSel('fFuente', opts.fuentes, 'Todas'); fillSel('fMedio', opts.mediosPY, 'Todos');
      fillSel('fSent', opts.sentimientos, 'Todos'); fillSel('fTema', opts.temas, 'Todos');
    }
    function fillSel(id, items, all) { var s = document.getElementById(id), v = s.value; s.innerHTML = '<option value="">' + all + '</option>'; (items || []).forEach(function (i) { var o = document.createElement('option'); o.value = i; o.textContent = i; s.appendChild(o) }); s.value = v; }

    function renderMentions() {
      var list = document.getElementById('mentionList');
      var start = (S.page - 1) * S.pageSize, end = Math.min(start + S.pageSize, S.rows.length);
      var html = '';
      for (var i = start; i < end; i++) {
        var r = S.rows[i];
        var sentCls = r.sentimiento === 'Positivo' ? 'badge-pos' : r.sentimiento === 'Negativo' ? 'badge-neg' : 'badge-neu';
        var gateCls = r.gateOK === 'SI' ? 'badge-gate-ok' : 'badge-gate-no';
        var gateIcon = r.gateOK === 'SI' ? '‚úì' : '‚úó';
        html += '<div class="mention-card">' +
          '<div class="mention-header">' +
          '<span class="' + gateCls + '" title="Gate: ' + escHtml(r.gateReason) + '">' + gateIcon + '</span>' +
          '<span class="badge badge-source">' + r.fuente + '</span>' +
          (r.medioPY ? '<span class="badge badge-py">üáµüáæ ' + escHtml(r.medioPY) + '</span>' : '') +
          (r.relevance ? '<span style="font-size:10px;color:var(--text-muted)">rel:' + r.relevance + '</span>' : '') +
          '</div>' +
          '<div class="mention-title"><a href="' + r.link + '" target="_blank">' + escHtml(r.titulo) + '</a></div>' +
          (r.snippet ? '<div class="mention-snippet">' + escHtml(r.snippet) + '</div>' : '') +
          '<div class="mention-footer">' +
          '<span class="badge ' + sentCls + '">' + r.sentimiento + ' (' + r.sentimientoScore + ')' + (r.confidence ? ' ¬∑ conf:' + Math.round(r.confidence * 100) + '%' : '') + '</span>' +
          (r.tema ? r.tema.split(', ').map(function (t) { return '<span class="badge badge-topic">' + t + '</span>' }).join('') : '') +
          '<span class="mention-meta">üïí ' + String(r.fechaPub).substring(0, 10) + (r.dominio ? ' ¬∑ ' + r.dominio : '') + '</span>' +
          '</div>' +
          '</div>';
      }
      list.innerHTML = html || '<div style="text-align:center;padding:40px;color:var(--text-muted)">No hay menciones</div>';
      renderPagination();
    }

    function renderPagination() {
      var totalP = Math.max(1, Math.ceil(S.rows.length / S.pageSize));
      var c = document.getElementById('pagination');
      if (totalP <= 1) { c.innerHTML = ''; return }
      var h = '<button onclick="goPage(1)">¬´</button><button onclick="goPage(' + Math.max(1, S.page - 1) + ')">‚Äπ</button>';
      var sP = Math.max(1, S.page - 2), eP = Math.min(totalP, S.page + 2);
      for (var p = sP; p <= eP; p++) h += '<button class="' + (p === S.page ? 'active' : '') + '" onclick="goPage(' + p + ')">' + p + '</button>';
      h += '<button onclick="goPage(' + Math.min(totalP, S.page + 1) + ')">‚Ä∫</button><button onclick="goPage(' + totalP + ')">¬ª</button>';
      h += '<span>' + S.page + '/' + totalP + '</span>';
      c.innerHTML = h;
    }
    function goPage(p) { S.page = p; renderMentions(); document.getElementById('tab-menciones').scrollTo(0, 0) }

    /* ‚ïê‚ïê‚ïê ALERTAS ‚ïê‚ïê‚ïê */
    function loadAlerts() {
      google.script.run.withSuccessHandler(function (data) {
        var rows = data.rows || [];
        var alertRows = rows.filter(function (r) { return r.sentimientoScore <= -0.3 && r.gateOK === 'SI' });
        var list = document.getElementById('alertList');
        var noA = document.getElementById('noAlerts');
        if (alertRows.length === 0) { list.innerHTML = ''; noA.style.display = 'block'; return; }
        noA.style.display = 'none';
        var html = '';
        alertRows.slice(0, 30).forEach(function (r) {
          var sev = r.sentimientoScore <= -0.7 ? 'critical' : r.sentimientoScore <= -0.5 ? 'high' : 'medium';
          html += '<div class="alert-card alert-' + sev + '">' +
            '<div class="alert-msg">' + (sev === 'critical' ? 'üî¥' : sev === 'high' ? 'üü†' : 'üü°') + ' ' + escHtml(r.titulo.substring(0, 100)) + '</div>' +
            '<div style="margin-top:6px"><span class="badge badge-neg">Score: ' + r.sentimientoScore + '</span> <span class="badge badge-source">' + r.fuente + '</span>' + (r.medioPY ? ' <span class="badge badge-py">' + r.medioPY + '</span>' : '') + '</div>' +
            '<div class="alert-time">' + String(r.fechaPub).substring(0, 10) + ' ¬∑ <a href="' + r.link + '" target="_blank" style="color:var(--blue);text-decoration:none">Ver noticia ‚Üí</a></div>' +
            '</div>';
        });
        list.innerHTML = html;
        var badge = document.getElementById('alertBadge');
        badge.textContent = alertRows.length;
        badge.style.display = alertRows.length > 0 ? 'inline' : 'none';
      }).getFilteredData({ gateOnly: true });
    }

    /* ‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê */
    function exportCSV() {
      showLoading('Generando CSV‚Ä¶');
      google.script.run.withSuccessHandler(function (csv) {
        hideLoading();
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href = url; a.download = 'paracel-menciones-' + (new Date().toISOString().split('T')[0]) + '.csv'; a.click();
        showToast('CSV descargado');
      }).withFailureHandler(function (e) { hideLoading(); showToast('Error: ' + e.message, 5000) }).exportToCSV(getFilters());
    }

    /* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
    document.addEventListener('DOMContentLoaded', function () { loadDashboard() });
  </script>
</body>

</html>