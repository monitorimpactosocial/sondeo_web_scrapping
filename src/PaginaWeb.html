<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor de OpiniÃ³n â€” PARACEL</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-primary:#0a0e1a;--bg-card:rgba(15,20,40,0.85);
  --bg-glass:rgba(255,255,255,0.04);--bg-glass-hover:rgba(255,255,255,0.08);
  --accent:#6c63ff;--accent-light:#8b83ff;--accent-glow:rgba(108,99,255,0.3);
  --green:#00e676;--red:#ff5252;--amber:#ffd740;--cyan:#00e5ff;
  --text:#e8eaf6;--text-dim:#9e9faf;--text-muted:#6b6c7e;
  --border:rgba(255,255,255,0.08);--radius:12px;--radius-sm:8px;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
  --font:'Segoe UI','Inter',system-ui,sans-serif;
}
body{font-family:var(--font);background:var(--bg-primary);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(108,99,255,0.08),transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(0,229,255,0.05),transparent 50%);pointer-events:none;z-index:0}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header{background:var(--bg-card);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100}
.header-logo{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--cyan));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#fff;box-shadow:0 0 20px var(--accent-glow)}
.header-title{flex:1}
.header-title h1{font-size:20px;font-weight:700;background:linear-gradient(90deg,var(--text),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-title p{font-size:12px;color:var(--text-dim);margin-top:2px}
.header-badge{background:var(--bg-glass);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:11px;color:var(--green);display:flex;align-items:center;gap:6px}
.header-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:4px;padding:12px 32px 0;background:var(--bg-card);border-bottom:1px solid var(--border)}
.tab{padding:10px 24px;font-size:13px;font-weight:600;color:var(--text-dim);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:all .3s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent-light);border-bottom-color:var(--accent)}
.tab-content{display:none;padding:24px 32px;position:relative;z-index:1}
.tab-content.active{display:block;animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* â”€â”€â”€ CARDS & KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.kpi{background:var(--bg-card);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:all .3s}
.kpi:hover{border-color:var(--accent);box-shadow:0 0 20px var(--accent-glow);transform:translateY(-2px)}
.kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px}
.kpi-value{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent-light),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.kpi-sub{font-size:11px;color:var(--text-dim);margin-top:4px}
.card{background:var(--bg-card);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* â”€â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:flex-end}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-group label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.filter-group select,.filter-group input{background:var(--bg-glass);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);padding:8px 12px;font-size:12px;font-family:var(--font);outline:none;min-width:140px;transition:border-color .3s}
.filter-group select:focus,.filter-group input:focus{border-color:var(--accent)}
.filter-group select option{background:#1a1e2e;color:var(--text)}

/* â”€â”€â”€ TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-dim)}
.toggle{position:relative;width:36px;height:20px;cursor:pointer}
.toggle input{display:none}
.toggle .slider{position:absolute;inset:0;background:var(--bg-glass);border:1px solid var(--border);border-radius:20px;transition:all .3s}
.toggle .slider::before{content:'';position:absolute;width:14px;height:14px;left:3px;top:2px;background:var(--text-dim);border-radius:50%;transition:all .3s}
.toggle input:checked+.slider{background:var(--accent);border-color:var(--accent)}
.toggle input:checked+.slider::before{transform:translateX(16px);background:#fff}

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{padding:10px 20px;border:none;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;font-family:var(--font)}
.btn-primary{background:linear-gradient(135deg,var(--accent),#5a52d5);color:#fff;box-shadow:0 4px 15px var(--accent-glow)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px var(--accent-glow)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.btn-sm{padding:6px 14px;font-size:11px;border-radius:6px}
.btn-outline{background:transparent;color:var(--accent-light);border:1px solid var(--accent)}
.btn-outline:hover{background:var(--accent);color:#fff}
.btn-danger{background:var(--red);color:#fff}

/* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:12px}
th{background:rgba(108,99,255,0.15);color:var(--accent-light);font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-size:10px;padding:10px 12px;text-align:left;position:sticky;top:0;white-space:nowrap}
td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text-dim);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:var(--bg-glass-hover);color:var(--text)}
td a{color:var(--cyan);text-decoration:none}
td a:hover{text-decoration:underline}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-pos{background:rgba(0,230,118,0.15);color:var(--green)}
.badge-neg{background:rgba(255,82,82,0.15);color:var(--red)}
.badge-neu{background:rgba(255,215,64,0.15);color:var(--amber)}
.badge-gate{background:rgba(0,229,255,0.15);color:var(--cyan)}

/* â”€â”€â”€ CHARTS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:16px;margin-bottom:24px}
.chart-container{position:relative;height:260px}

/* â”€â”€â”€ SEARCH TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:16px 0}
.status-item{background:var(--bg-glass);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;display:flex;flex-direction:column;gap:4px}
.status-item .label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.status-item .value{font-size:14px;font-weight:600;color:var(--text)}
.kw-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.kw-chip{background:var(--bg-glass);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:12px;display:flex;align-items:center;gap:8px;transition:all .3s}
.kw-chip.active{border-color:var(--green);color:var(--green)}
.kw-chip.inactive{border-color:var(--text-muted);color:var(--text-muted);opacity:0.6}
.kw-toggle{width:8px;height:8px;border-radius:50%;cursor:pointer}
.kw-toggle.on{background:var(--green)}
.kw-toggle.off{background:var(--text-muted)}
.add-kw{display:flex;gap:8px;margin-top:12px}
.add-kw input{flex:1}

/* â”€â”€â”€ PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:16px}
.pagination button{background:var(--bg-glass);border:1px solid var(--border);color:var(--text-dim);border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer}
.pagination button:hover{border-color:var(--accent);color:var(--accent-light)}
.pagination button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.pagination span{font-size:12px;color:var(--text-dim)}

/* â”€â”€â”€ LOADING & TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading{display:none;position:fixed;inset:0;background:rgba(10,14,26,0.8);z-index:1000;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loading.show{display:flex}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:14px;color:var(--text-dim)}
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:12px 20px;font-size:13px;color:var(--text);z-index:1001;box-shadow:var(--shadow);transform:translateY(100px);opacity:0;transition:all .4s}
.toast.show{transform:translateY(0);opacity:1}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  .header{padding:12px 16px}
  .tabs{padding:8px 16px 0}
  .tab-content{padding:16px}
  .filters{flex-direction:column}
  .filter-group select,.filter-group input{min-width:100%}
  .charts-grid{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">P</div>
  <div class="header-title">
    <h1>Monitor de OpiniÃ³n â€” PARACEL</h1>
    <p>Sondeo Web Scrapping Â· Monitoreo de Impacto Social</p>
  </div>
  <div class="header-badge">Sistema Activo</div>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('busqueda')">ğŸ” BÃºsqueda</button>
  <button class="tab" onclick="switchTab('tablero')">ğŸ“Š Tablero</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TAB 1: BÃšSQUEDA â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-busqueda" class="tab-content active">
  <div class="card">
    <div class="card-title">âš¡ EjecuciÃ³n Manual</div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn btn-primary" id="btnSearch" onclick="ejecutarBusqueda()">ğŸš€ Ejecutar BÃºsqueda</button>
      <div class="toggle-row">
        <label class="toggle"><input type="checkbox" id="toggleGate" checked><span class="slider"></span></label>
        Gate activo
      </div>
      <div class="toggle-row">
        <label class="toggle"><input type="checkbox" id="toggleSoloPY"><span class="slider"></span></label>
        Solo medios PY
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“¡ Ãšltimo Estado</div>
    <div class="status-panel" id="statusPanel">
      <div class="status-item"><span class="label">Ãšltima ejecuciÃ³n</span><span class="value" id="stLastRun">â€”</span></div>
      <div class="status-item"><span class="label">DuraciÃ³n</span><span class="value" id="stDuration">â€”</span></div>
      <div class="status-item"><span class="label">Nuevas menciones</span><span class="value" id="stNew">â€”</span></div>
      <div class="status-item"><span class="label">Duplicadas</span><span class="value" id="stDup">â€”</span></div>
      <div class="status-item"><span class="label">Gate OK</span><span class="value" id="stGateOK">â€”</span></div>
      <div class="status-item"><span class="label">Errores</span><span class="value" id="stErrors">â€”</span></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ”‘ Palabras Clave</div>
    <div id="kwList" class="kw-list"></div>
    <div class="add-kw">
      <input type="text" id="newKwInput" placeholder="Nueva keywordâ€¦" class="filter-group">
      <button class="btn btn-sm btn-outline" onclick="agregarKeyword()">+ Agregar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TAB 2: TABLERO â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-tablero" class="tab-content">
  <!-- FILTERS -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">ğŸ›ï¸ Filtros</div>
    <div class="filters">
      <div class="filter-group"><label>Fuente</label><select id="fFuente"><option value="">Todas</option></select></div>
      <div class="filter-group"><label>Medio PY</label><select id="fMedioPY"><option value="">Todos</option></select></div>
      <div class="filter-group"><label>Sentimiento</label><select id="fSentimiento"><option value="">Todos</option></select></div>
      <div class="filter-group"><label>Tema</label><select id="fTema"><option value="">Todos</option></select></div>
      <div class="filter-group"><label>Desde</label><input type="date" id="fDesde"></div>
      <div class="filter-group"><label>Hasta</label><input type="date" id="fHasta"></div>
      <div class="filter-group"><label>Buscar</label><input type="text" id="fBusqueda" placeholder="Texto libreâ€¦"></div>
      <div class="filter-group" style="justify-content:flex-end">
        <div class="toggle-row"><label class="toggle"><input type="checkbox" id="fGateOnly"><span class="slider"></span></label> Solo Gate OK</div>
      </div>
      <div class="filter-group" style="justify-content:flex-end">
        <div class="toggle-row"><label class="toggle"><input type="checkbox" id="fSoloPY"><span class="slider"></span></label> Solo Medios PY</div>
      </div>
      <div class="filter-group" style="justify-content:flex-end">
        <button class="btn btn-primary btn-sm" onclick="applyFilters()">Aplicar</button>
        <button class="btn btn-sm btn-outline" onclick="resetFilters()" style="margin-top:4px">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi"><div class="kpi-label">Total Menciones</div><div class="kpi-value" id="kpiTotal">0</div></div>
    <div class="kpi"><div class="kpi-label">Menciones Hoy</div><div class="kpi-value" id="kpiHoy">0</div></div>
    <div class="kpi"><div class="kpi-label">% Positivas</div><div class="kpi-value" id="kpiPos">0%</div><div class="kpi-sub" id="kpiPosDetail"></div></div>
    <div class="kpi"><div class="kpi-label">Top Medio PY</div><div class="kpi-value" id="kpiTopPY" style="font-size:18px">â€”</div></div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="card"><div class="card-title">ğŸ“ˆ Tendencia Diaria</div><div class="chart-container"><canvas id="chartTrend"></canvas></div></div>
    <div class="card"><div class="card-title">ğŸ˜Š Sentimiento</div><div class="chart-container"><canvas id="chartSent"></canvas></div></div>
    <div class="card"><div class="card-title">ğŸ“¡ Fuentes</div><div class="chart-container"><canvas id="chartSrc"></canvas></div></div>
    <div class="card"><div class="card-title">ğŸ‡µğŸ‡¾ Medios Paraguay</div><div class="chart-container"><canvas id="chartMedia"></canvas></div></div>
    <div class="card" style="grid-column:span 2"><div class="card-title">ğŸ·ï¸ Temas</div><div class="chart-container"><canvas id="chartTopics"></canvas></div></div>
  </div>

  <!-- DATA TABLE -->
  <div class="card">
    <div class="card-title">ğŸ“‹ Menciones <span id="tableCount" style="font-weight:400;color:var(--text-dim);font-size:12px"></span></div>
    <div class="table-wrap" style="max-height:500px;overflow-y:auto">
      <table id="dataTable">
        <thead><tr>
          <th>Fecha</th><th>Fuente</th><th>TÃ­tulo</th><th>Dominio</th>
          <th>Medio PY</th><th>Gate</th><th>Sentimiento</th><th>Temas</th>
        </tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div class="loading" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Procesandoâ€¦</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var state = {
  currentTab: 'busqueda',
  rows: [],
  stats: {},
  page: 1,
  pageSize: 50,
  charts: {}
};

/* â”€â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchTab(tab) {
  state.currentTab = tab;
  document.querySelectorAll('.tab').forEach(function(t, i) {
    t.classList.toggle('active', (i === 0 && tab === 'busqueda') || (i === 1 && tab === 'tablero'));
  });
  document.querySelectorAll('.tab-content').forEach(function(c) {
    c.classList.remove('active');
  });
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'busqueda') loadSearchStatus();
  else loadDashboard();
}

/* â”€â”€â”€ LOADING & TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showLoading(msg) {
  document.getElementById('loadingText').textContent = msg || 'Procesandoâ€¦';
  document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
function showToast(msg, dur) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, dur || 3000);
}

/* â”€â”€â”€ SEARCH TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadSearchStatus() {
  google.script.run.withSuccessHandler(function(exec) {
    if (!exec) return;
    document.getElementById('stLastRun').textContent = exec.timestamp || 'â€”';
    document.getElementById('stDuration').textContent = exec.duracion ? exec.duracion + 's' : 'â€”';
    document.getElementById('stNew').textContent = exec.nuevas != null ? exec.nuevas : 'â€”';
    document.getElementById('stDup').textContent = exec.duplicadas != null ? exec.duplicadas : 'â€”';
    document.getElementById('stGateOK').textContent = exec.gateOK != null ? exec.gateOK : 'â€”';
    document.getElementById('stErrors').textContent = exec.errores != null ? exec.errores : '0';
  }).getLastExecution();
  loadKeywords();
}

function loadKeywords() {
  google.script.run.withSuccessHandler(function(kws) {
    var container = document.getElementById('kwList');
    container.innerHTML = '';
    (kws || []).forEach(function(kw) {
      var cls = String(kw.activa).toUpperCase() === 'SI' ? 'active' : 'inactive';
      var dotCls = String(kw.activa).toUpperCase() === 'SI' ? 'on' : 'off';
      var chip = document.createElement('div');
      chip.className = 'kw-chip ' + cls;
      chip.innerHTML = '<span class="kw-toggle ' + dotCls + '" onclick="toggleKw(\'' +
        kw.keyword.replace(/'/g, "\\'") + '\',' + (cls === 'active' ? 'false' : 'true') + ')"></span>' + kw.keyword;
      container.appendChild(chip);
    });
  }).getKeywords();
}

function toggleKw(keyword, activa) {
  google.script.run.withSuccessHandler(function() {
    loadKeywords(); showToast('Keyword actualizada');
  }).toggleKeyword(keyword, activa);
}

function agregarKeyword() {
  var inp = document.getElementById('newKwInput');
  var val = inp.value.trim();
  if (!val) return;
  google.script.run.withSuccessHandler(function() {
    inp.value = ''; loadKeywords(); showToast('Keyword agregada');
  }).addKeyword(val);
}

function ejecutarBusqueda() {
  var btn = document.getElementById('btnSearch');
  btn.disabled = true;
  showLoading('Ejecutando bÃºsquedaâ€¦ esto puede tomar 1-3 minutos');
  google.script.run.withSuccessHandler(function(res) {
    hideLoading(); btn.disabled = false;
    if (res && res.status === 'ok') {
      showToast('âœ… ' + res.nuevas + ' nuevas menciones encontradas (' + res.duplicadas + ' duplicadas)');
    } else {
      showToast('âš ï¸ ' + (res ? res.message || 'Sin resultados' : 'Error'), 5000);
    }
    loadSearchStatus();
  }).withFailureHandler(function(e) {
    hideLoading(); btn.disabled = false;
    showToast('âŒ Error: ' + e.message, 5000);
  }).runManualSearch();
}

/* â”€â”€â”€ DASHBOARD TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getFilters() {
  return {
    fuente: document.getElementById('fFuente').value,
    medioPY: document.getElementById('fMedioPY').value,
    sentimiento: document.getElementById('fSentimiento').value,
    tema: document.getElementById('fTema').value,
    fechaDesde: document.getElementById('fDesde').value,
    fechaHasta: document.getElementById('fHasta').value,
    busqueda: document.getElementById('fBusqueda').value,
    gateOnly: document.getElementById('fGateOnly').checked,
    soloMediosPY: document.getElementById('fSoloPY').checked
  };
}

function applyFilters() { state.page = 1; loadDashboard(); }
function resetFilters() {
  ['fFuente','fMedioPY','fSentimiento','fTema'].forEach(function(id) { document.getElementById(id).value = ''; });
  document.getElementById('fDesde').value = '';
  document.getElementById('fHasta').value = '';
  document.getElementById('fBusqueda').value = '';
  document.getElementById('fGateOnly').checked = false;
  document.getElementById('fSoloPY').checked = false;
  applyFilters();
}

function loadDashboard() {
  showLoading('Cargando tableroâ€¦');
  var filters = getFilters();
  google.script.run.withSuccessHandler(function(stats) {
    state.stats = stats || {};
    updateKPIs(stats);
    updateCharts(stats);
    google.script.run.withSuccessHandler(function(data) {
      hideLoading();
      state.rows = data.rows || [];
      renderTable();
      document.getElementById('tableCount').textContent = '(' + state.rows.length + ' resultados)';
    }).getFilteredData(filters);
  }).withFailureHandler(function(e) {
    hideLoading(); showToast('Error cargando datos: ' + e.message, 5000);
  }).getDashboardStats(filters);
  // Load filter options
  google.script.run.withSuccessHandler(populateFilterOptions).getFilterOptions();
}

function populateFilterOptions(opts) {
  if (!opts) return;
  fillSelect('fFuente', opts.fuentes, 'Todas');
  fillSelect('fMedioPY', opts.mediosPY, 'Todos');
  fillSelect('fSentimiento', opts.sentimientos, 'Todos');
  fillSelect('fTema', opts.temas, 'Todos');
}

function fillSelect(id, items, allLabel) {
  var sel = document.getElementById(id);
  var current = sel.value;
  sel.innerHTML = '<option value="">' + allLabel + '</option>';
  (items || []).forEach(function(item) {
    var opt = document.createElement('option');
    opt.value = item; opt.textContent = item;
    sel.appendChild(opt);
  });
  sel.value = current;
}

/* â”€â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateKPIs(s) {
  document.getElementById('kpiTotal').textContent = s.total || 0;
  document.getElementById('kpiHoy').textContent = s.hoy || 0;
  var pctPos = s.total > 0 ? Math.round(s.positivas / s.total * 100) : 0;
  document.getElementById('kpiPos').textContent = pctPos + '%';
  document.getElementById('kpiPosDetail').textContent = s.positivas + ' pos Â· ' + s.neutrales + ' neu Â· ' + s.negativas + ' neg';
  document.getElementById('kpiTopPY').textContent = s.topMedioPY || 'â€”';
}

/* â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function destroyChart(key) { if (state.charts[key]) { state.charts[key].destroy(); state.charts[key] = null; } }

function updateCharts(s) {
  // Trend
  destroyChart('trend');
  var trendLabels = Object.keys(s.tendenciaDiaria || {}).sort();
  var trendData = trendLabels.map(function(k) { return s.tendenciaDiaria[k]; });
  state.charts.trend = new Chart(document.getElementById('chartTrend'), {
    type: 'line',
    data: { labels: trendLabels, datasets: [{ label: 'Menciones', data: trendData, borderColor: '#6c63ff', backgroundColor: 'rgba(108,99,255,0.1)', tension: 0.4, fill: true, pointRadius: 3 }] },
    options: chartOpts('Tendencia Diaria')
  });

  // Sentiment
  destroyChart('sent');
  state.charts.sent = new Chart(document.getElementById('chartSent'), {
    type: 'doughnut',
    data: { labels: ['Positivo','Neutral','Negativo'], datasets: [{ data: [s.positivas||0, s.neutrales||0, s.negativas||0], backgroundColor: ['#00e676','#ffd740','#ff5252'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#9e9faf', font: { size: 11 } } } } }
  });

  // Sources
  destroyChart('src');
  var srcLabels = Object.keys(s.porFuente || {});
  var srcData = srcLabels.map(function(k) { return s.porFuente[k]; });
  state.charts.src = new Chart(document.getElementById('chartSrc'), {
    type: 'bar',
    data: { labels: srcLabels, datasets: [{ label: 'Menciones', data: srcData, backgroundColor: 'rgba(0,229,255,0.6)', borderRadius: 6 }] },
    options: chartOpts('Fuentes')
  });

  // Media PY
  destroyChart('media');
  var mediaLabels = Object.keys(s.porMedioPY || {}).sort(function(a, b) { return s.porMedioPY[b] - s.porMedioPY[a]; }).slice(0, 10);
  var mediaData = mediaLabels.map(function(k) { return s.porMedioPY[k]; });
  state.charts.media = new Chart(document.getElementById('chartMedia'), {
    type: 'bar',
    data: { labels: mediaLabels, datasets: [{ label: 'Menciones', data: mediaData, backgroundColor: 'rgba(108,99,255,0.6)', borderRadius: 6 }] },
    options: Object.assign({}, chartOpts('Medios PY'), { indexAxis: 'y' })
  });

  // Topics
  destroyChart('topics');
  var topicLabels = Object.keys(s.porTema || {});
  var topicData = topicLabels.map(function(k) { return s.porTema[k]; });
  var topicColors = ['rgba(0,230,118,0.6)','rgba(255,82,82,0.6)','rgba(108,99,255,0.6)','rgba(255,215,64,0.6)','rgba(0,229,255,0.6)'];
  state.charts.topics = new Chart(document.getElementById('chartTopics'), {
    type: 'bar',
    data: { labels: topicLabels, datasets: [{ label: 'Menciones', data: topicData, backgroundColor: topicColors, borderRadius: 6 }] },
    options: chartOpts('Temas')
  });
}

function chartOpts(title) {
  return {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false }, title: { display: false } },
    scales: {
      x: { ticks: { color: '#6b6c7e', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
      y: { ticks: { color: '#6b6c7e', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' }, beginAtZero: true }
    }
  };
}

/* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTable() {
  var tbody = document.getElementById('tableBody');
  var start = (state.page - 1) * state.pageSize;
  var end = Math.min(start + state.pageSize, state.rows.length);
  var html = '';
  for (var i = start; i < end; i++) {
    var r = state.rows[i];
    var sentClass = r.sentimiento === 'Positivo' ? 'badge-pos' : r.sentimiento === 'Negativo' ? 'badge-neg' : 'badge-neu';
    var gateClass = r.gateOK === 'SI' ? 'badge-pos' : 'badge-neg';
    html += '<tr>' +
      '<td>' + String(r.fechaPub).substring(0, 10) + '</td>' +
      '<td>' + r.fuente + '</td>' +
      '<td><a href="' + r.link + '" target="_blank" title="' + escHtml(r.snippet) + '">' + escHtml(r.titulo.substring(0, 80)) + '</a></td>' +
      '<td>' + r.dominio + '</td>' +
      '<td>' + (r.medioPY || 'â€”') + '</td>' +
      '<td><span class="badge ' + gateClass + '">' + r.gateOK + '</span></td>' +
      '<td><span class="badge ' + sentClass + '">' + r.sentimiento + ' (' + r.sentimientoScore + ')</span></td>' +
      '<td>' + (r.tema || 'â€”') + '</td>' +
      '</tr>';
  }
  tbody.innerHTML = html;
  renderPagination();
}

function renderPagination() {
  var totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
  var container = document.getElementById('pagination');
  if (totalPages <= 1) { container.innerHTML = ''; return; }
  var html = '<button onclick="goPage(1)">&laquo;</button>';
  html += '<button onclick="goPage(' + Math.max(1, state.page - 1) + ')">&lsaquo;</button>';
  var startP = Math.max(1, state.page - 2);
  var endP = Math.min(totalPages, state.page + 2);
  for (var p = startP; p <= endP; p++) {
    html += '<button class="' + (p === state.page ? 'active' : '') + '" onclick="goPage(' + p + ')">' + p + '</button>';
  }
  html += '<button onclick="goPage(' + Math.min(totalPages, state.page + 1) + ')">&rsaquo;</button>';
  html += '<button onclick="goPage(' + totalPages + ')">&raquo;</button>';
  html += '<span>PÃ¡g ' + state.page + '/' + totalPages + '</span>';
  container.innerHTML = html;
}

function goPage(p) { state.page = p; renderTable(); }

function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

/* â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', function() { loadSearchStatus(); });
</script>
</body>
</html>
